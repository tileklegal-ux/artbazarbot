import os
from typing import Literal

from openai import AsyncOpenAI

from database import get_user_language

# Используем ключ из переменной окружения
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_API_KEY:
    raise RuntimeError("OPENAI_API_KEY не задан в переменных окружения")

# Модель можно переопределить через env, по умолчанию — быстрая и дешёвая
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4.1-mini")

client = AsyncOpenAI(api_key=OPENAI_API_KEY)


LangCode = Literal["ru", "kg", "kz"]


def _get_lang(user_id: int) -> LangCode:
    lang = get_user_language(user_id) or "ru"
    if lang not in ("ru", "kg", "kz"):
        return "ru"
    return lang  # type: ignore[return-value]


def _system_prompt_analyze(lang: LangCode) -> str:
    if lang == "kg":
        return (
            "Сен товардык бизнес боюнча экспертсиң. Кыргызстан, Казакстан, Россия "
            "рыногун эске алып анализ кыл. Жоопту кыргызча, түшүнүктүү жана кыска бер. "
            "Эсептөөлөрдү жөнөкөй тил менен, бизнеске пайдалуу кыл."
        )
    if lang == "kz":
        return (
            "Сен тауарлық бизнес бойынша экспертсің. Қазақстан, Қырғызстан, Ресей "
            "нарықтарын ескеріп талдау жаса. Жауапты қазақша, түсінікті және қысқа бер. "
            "Есептеулерді қарапайым тілмен, бизнестің пайдасына бағытта."
        )
    # ru
    return (
        "Ты эксперт по товарному бизнесу в СНГ (Казахстан, Кыргызстан, Россия). "
        "Отвечай простым языком, структурно, без воды и мотивашки. "
        "Фокус — практичный анализ, цифры, риски, конкретные рекомендации."
    )


def _system_prompt_niche(lang: LangCode) -> str:
    if lang == "kg":
        return (
            "Сен ниша тандоо боюнча консультантсың. Кыргызстан, Казакстан, Россия "
            "рыногун эске алып, нишанын плюсу-минусун, тобокелдиктерин жана потенциалын "
            "чыгар. Жоопту структуралуу жана кыргызча жаз."
        )
    if lang == "kz":
        return (
            "Сен ниша таңдауға көмектесетін бизнес-консультантсың. Қазақстан, Қырғызстан, "
            "Ресей нарығын ескеріп, нишаның плюс-минусын, тәуекелдерін және потенциалын жаз. "
            "Жауапты құрылымды және қазақша бер."
        )
    return (
        "Ты бизнес-консультант по выбору ниши. Анализируй нишу честно: спрос, конкуренция, "
        "сложность входа, риски, сезонность, потенциал. Пиши структурно и по делу."
    )


def _system_prompt_reco(lang: LangCode) -> str:
    if lang == "kg":
        return (
            "Сен сатуу боюнча практикалык кеңешчиcиң. Колдонуучу товарын же ситуациясын "
            "жазганда, ага реалдуу, жерге жакын кеңеш бер: кандай контент, кандай оффер, "
            "кандай платформа, кандай шагдар."
        )
    if lang == "kz":
        return (
            "Сен сатылым бойынша практик кеңесшісің. Пайдаланушы тауарын немесе жағдайын "
            "жазғанда, оған жерге жақын, өміршең кеңес бер: қандай контент, қандай оффер, "
            "қандай платформа, қандай қадамдар."
        )
    return (
        "Ты даёшь практичные советы по продажам. Без общих фраз, только конкретика: "
        "что менять в продукте, оффере, креативах, позиционировании и воронке."
    )


async def _call_openai(system_prompt: str, user_content: str) -> str:
    resp = await client.chat.completions.create(
        model=OPENAI_MODEL,
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_content},
        ],
        temperature=0.4,
    )
    return resp.choices[0].message.content.strip()


# ---------------- Публичные функции ----------------


async def analyze_market(user_text: str, user_id: int) -> str:
    """
    Анализ рынка под товар/нишу.
    """
    lang = _get_lang(user_id)

    if lang == "kg":
        user_prompt = (
            "Колдонуучунун тексти төмөндө.\n"
            "Кыргызстан, Казакстан, Россия рыногун эске алып талда:\n"
            "• суроо-талап\n"
            "• атаандаштар\n"
            "• баа диапазону\n"
            "• маржа мүмкүнчүлүгү\n"
            "• тобокелдиктер\n"
            "• 30 күндүк перспектива\n\n"
            f"Колдонуучунун тексти:\n{user_text}"
        )
    elif lang == "kz":
        user_prompt = (
            "Пайдаланушының мәтіні төменде.\n"
            "Қазақстан, Қырғызстан, Ресей нарықтарын ескеріп талда:\n"
            "• сұраныс\n"
            "• бәсекелестер\n"
            "• баға диапазоны\n"
            "• маржа мүмкіндігі\n"
            "• тәуекелдер\n"
            "• 30 күндік перспектива\n\n"
            f"Пайдаланушы мәтіні:\n{user_text}"
        )
    else:
        user_prompt = (
            "Ниже текст пользователя.\n"
            "Сделай анализ рынка для СНГ (РФ, КЗ, КГ):\n"
            "• спрос\n"
            "• конкуренция\n"
            "• ценовой коридор\n"
            "• примерную маржинальность\n"
            "• ключевые риски\n"
            "• стоит ли заходить сейчас\n"
            "• что проверить перед стартом\n\n"
            f"Текст пользователя:\n{user_text}"
        )

    system_prompt = _system_prompt_analyze(lang)
    return await _call_openai(system_prompt, user_prompt)


async def pick_niche(user_text: str, user_id: int) -> str:
    """
    Выбор ниши: оценка идеи.
    """
    lang = _get_lang(user_id)

    if lang == "kg":
        user_prompt = (
            "Колдонуучу ниша жөнүндө ойлорун жазды.\n"
            "Кыргызстан, Казакстан, Россия рыногун эске алып, бул нишанын:\n"
            "• плюс жана минустарын\n"
            "• баштапкы стартка канчалык оор экенин\n"
            "• канча капитал керек болушу мүмкүн экенин (диапазон менен)\n"
            "• жалпы потенциалын\n"
            "кыскача жаз.\n\n"
            f"Колдонуучунун тексти:\n{user_text}"
        )
    elif lang == "kz":
        user_prompt = (
            "Пайдаланушы ниша туралы ойын жазды.\n"
            "Қазақстан, Қырғызстан, Ресей нарығын ескеріп, осы нишаның:\n"
            "• плюсы мен минусын\n"
            "• старттың қаншалықты қиын екенін\n"
            "• шамамен қанша капитал қажет болуы мүмкін екенін\n"
            "• жалпы потенциалын\n"
            "қысқаша түсіндір.\n\n"
            f"Пайдаланушы мәтіні:\n{user_text}"
        )
    else:
        user_prompt = (
            "Пользователь описал нишу, которую рассматривает.\n"
            "Дай честный разбор:\n"
            "• сильные и слабые стороны\n"
            "• сложность входа (по шкале: легко / средне / тяжело)\n"
            "• примерный бюджет на старт (диапазон)\n"
            "• есть ли перспективы и на каком горизонте\n\n"
            f"Описание ниши:\n{user_text}"
        )

    system_prompt = _system_prompt_niche(lang)
    return await _call_openai(system_prompt, user_prompt)


async def recommendations(user_text: str, user_id: int) -> str:
    """
    Рекомендации по продажам под конкретный товар/ситуацию.
    """
    lang = _get_lang(user_id)

    if lang == "kg":
        user_prompt = (
            "Колдонуучу товарын жана ситуациясын түшүндүрдү.\n"
            "Ага сатуу жагынан практикалык кеңеш бер:\n"
            "• кандай позиция кылуу керек\n"
            "• кандай оффер берсе иштейт\n"
            "• контент боюнча 3 идея\n"
            "• кайсы платформаларга басым жасоо керек (IG, TikTok, Telegram ж.б.)\n\n"
            f"Колдонуучунун тексти:\n{user_text}"
        )
    elif lang == "kz":
        user_prompt = (
            "Пайдаланушы тауарын және жағдайын түсіндірді.\n"
            "Сатылым тұрғысынан практик кеңес бер:\n"
            "• қалай позициялау керек\n"
            "• қандай оффер жұмыс істеуі мүмкін\n"
            "• контентке 3 идея\n"
            "• қандай платформаларға басымдық беру керек (IG, TikTok, Telegram, т.б.)\n\n"
            f"Пайдаланушы мәтіні:\n{user_text}"
        )
    else:
        user_prompt = (
            "Пользователь описал товар и свою ситуацию.\n"
            "Дай практичные рекомендации:\n"
            "• как лучше позиционировать товар\n"
            "• какие офферы протестировать\n"
            "• 3–5 идей для контента\n"
            "• на каких площадках делать упор (IG, TikTok, Telegram и т.д.)\n\n"
            f"Описание пользователя:\n{user_text}"
        )

    system_prompt = _system_prompt_reco(lang)
    return await _call_openai(system_prompt, user_prompt)
