# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
from messages import MESSAGES 

def calculate_margin(cost, delivery, marketing, price, extra_fees):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞—Ä–∂—É –∏ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (ROM).
    –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö ($).
    """
    total_cost = cost + delivery + marketing + extra_fees
    profit = price - total_cost
    
    # –†–∞—Å—á–µ—Ç ROM (Return on Margin) = (–ü—Ä–∏–±—ã–ª—å / –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏) * 100
    if price > 0:
        rom = (profit / price) * 100
    else:
        rom = 0.0 # –ù–µ–ª—å–∑—è –¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–æ–ª—å

    return {
        "cost": cost,
        "delivery": delivery,
        "marketing": marketing,
        "extra_fees": extra_fees,
        "total_cost": total_cost,
        "price": price,
        "profit": profit,
        "rom": rom
    }

def format_margin_report(result: dict, lang_code: str):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –æ —Ä–∞—Å—á–µ—Ç–µ –º–∞—Ä–∂–∏ –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ."""
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç—ã –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫–∏–π –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π)
    # –ó–¥–µ—Å—å –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º T[lang_code], —Ç–∞–∫ –∫–∞–∫ –Ω–∞–º –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
    # —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ messages.py (–Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
    T = MESSAGES.get(lang_code, MESSAGES["ru"])
    
    # –•–µ–ª–ø–µ—Ä –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª
    def fmt(value):
        return f"{value:,.2f} $"

    report = f"""
üßÆ **{T['calc_start']}**
*(–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞)*

---
**–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:**
üì¶ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞: *{fmt(result['cost'])}*
üöö –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É: *{fmt(result['delivery'])}*
üì¢ –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥: *{fmt(result['marketing'])}*
‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: *{fmt(result['extra_fees'])}*

**–ò–¢–û–ì–ò:**
üí∞ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: **{fmt(result['price'])}**
üíµ –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: **{fmt(result['total_cost'])}**
---
**–†–ï–ó–£–õ–¨–¢–ê–¢:**
üí∏ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: **{fmt(result['profit'])}**
üìà –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (ROM): **{result['rom']:.1f} %**

{"‚úÖ *–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –ø—Ä–æ–¥–∞–∂–µ.*" if result['profit'] > 0 else "‚ùå *–ü—Ä–æ–¥–∞–∂–∞ –Ω–µ—Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–∞.*"}
"""
    return report
