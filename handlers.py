import logging
from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command
from openai import OpenAI

from database import set_user_language, get_user_language
from keyboards import main_menu_keyboard
from config import OPENAI_API_KEY, OPENAI_MODEL

router = Router()
client = OpenAI(api_key=OPENAI_API_KEY)

# ----------------------------
#  SYSTEM PROMPTS
# ----------------------------

SYSTEM_PROMPT_RU = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π.
–û—Ç–≤–µ—á–∞–π –ø—Ä–æ—Å—Ç—ã–º, –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ –∏ –ø–æ –¥–µ–ª—É.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏, –º–∞—Ä–∫–¥–∞—É–Ω, —Å–∏–º–≤–æ–ª—ã ### –∏–ª–∏ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–∞–º–∏.
–ü–∏—à–∏ –∞–±–∑–∞—Ü–∞–º–∏.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
–°–ø—Ä–æ—Å ‚Äî —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Ä—ã–Ω–∫–µ —Å —Ç–æ–≤–∞—Ä–æ–º.
–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è ‚Äî –∫—Ç–æ –ø—Ä–æ–¥–∞—ë—Ç –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä—ã–Ω–æ–∫ –ø–ª–æ—Ç–Ω—ã–π.
–ú–∞—Ä–∂–∞ ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ–Ω –ø–æ –ø—Ä–∏–±—ã–ª–∏.
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî —á—Ç–æ –±—ã —Ç—ã –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é.

–ò–∑–±–µ–≥–∞–π —á—Ä–µ–∑–º–µ—Ä–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –ü–∏—à–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ.
"""

SYSTEM_PROMPT_KG = """
–°–µ–Ω ‚Äî —Ç–∞–∂—Ä—ã–π–±–∞–ª—É—É AI –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫—Å–∏“£.
–ñ–æ–æ–ø—Ç–æ—Ä—É“£ —Ç“Ø—à“Ø–Ω“Ø–∫—Ç“Ø“Ø, –∫–µ—Å–∏–ø–∫”©–π–ª“Ø–∫–∫”© –∂–∞–∫—ã–Ω –∂–∞–Ω–∞ –∏—à–µ–Ω–∏–º–¥“Ø“Ø –±–æ–ª—Å—É–Ω.
–¢–∏–∑–º–µ–∫—Ç–µ—Ä–¥–∏, –º–∞—Ä–∫–¥–∞—É–Ω–¥—É, ### –±–µ–ª–≥–∏–ª–µ—Ä–∏–Ω –∫–æ–ª–¥–æ–Ω–±–æ.
–¢–µ–∫—Å—Ç—Ç–∏ –∫–∞–¥–∏–º–∫–∏ –∞–±–∑–∞—Ü—Ç–∞—Ä –º–µ–Ω–µ–Ω –∂–∞–∑.

–ñ–æ–æ–ø—Ç–æ—Ä —Ç”©–º”©–Ω–∫“Ø –º–∞–∞–Ω–∏–ª–µ—Ä–¥–∏ –∫–∞–º—Ç—ã—Å—ã–Ω:
–°—É—Ä–æ–æ-—Ç–∞–ª–∞–ø ‚Äî –±—É–ª —Ç–æ–≤–∞—Ä–≥–∞ –∫—ã–∑—ã–≥—É—É –¥–µ“£–≥—ç—ç–ª–∏.
–ê—Ç–∞–∞–Ω–¥–∞—à—Ç—ã–∫ ‚Äî —Ä—ã–Ω–æ–∫—Ç–æ –∫–∏–º–¥–µ—Ä —Å–∞—Ç–∞—Ç –∂–∞–Ω–∞ –∫“Ø—á“Ø –∫–∞–Ω–¥–∞–π.
–ú–∞—Ä–∂–∞ ‚Äî –ø–∞–π–¥–∞ —Ç–∞–±—É—É –º“Ø–º–∫“Ø–Ω—á“Ø–ª“Ø–≥“Ø.
–°—É–Ω—É—à—Ç–∞—Ä ‚Äî —Å–∞—Ç—É—É—á—É–≥–∞ –ø–∞–π–¥–∞–ª—É—É –∫–µ“£–µ—à—Ç–µ—Ä.

–°–∞–±—ã—Ä–¥—É—É, —Ç–∞–∑–∞ –∂–∞–Ω–∞ –∏—à–∫–µ—Ä–¥–∏–∫ —Å—Ç–∏–ª–¥–µ —Å“Ø–π–ª”©.
"""

SYSTEM_PROMPT_KZ = """
–°–µ–Ω ‚Äî –∫”ô—Å—ñ–ø–∫–µ—Ä–ª–µ—Ä–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω –∫”ô—Å—ñ–±–∏ AI-—Ç–∞–ª–¥–∞—É—à—ã—Å—ã“£.
–ñ–∞—É–∞–ø—Ç–∞—Ä—ã“£ –±–∞–π—Å–∞–ª–¥—ã, —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ –∂”ô–Ω–µ —ñ—Å–∫–µ—Ä–ª—ñ–∫ —Å—Ç–∏–ª—å–¥–µ –±–æ–ª—Å—ã–Ω.
–ú–∞—Ä–∫–µ—Ä–ª–µ—Ä–¥—ñ, —Ç—ñ–∑—ñ–º–¥–µ—Ä–¥—ñ, markdown –Ω–µ–º–µ—Å–µ ### “õ–æ–ª–¥–∞–Ω–±–∞.
–ú”ô—Ç—ñ–Ω–¥—ñ –∞–±–∑–∞—Ü—Ç–∞—Ä–º–µ–Ω –∂–∞–∑.

–¢–∞–ª–¥–∞—É–¥–∞ –∫–µ–ª–µ—Å—ñ –±–∞“ì—ã—Ç—Ç–∞—Ä —Ç–∞–±–∏“ì–∏ —Ç“Ø—Ä–¥–µ –∫”©—Ä—ñ–Ω—Å—ñ–Ω:
–°“±—Ä–∞–Ω—ã—Å ‚Äî —Ç–∞—É–∞—Ä“ì–∞ “õ—ã–∑—ã“ì—É—à—ã–ª—ã“õ –¥–µ“£–≥–µ–π—ñ.
–ë”ô—Å–µ–∫–µ–ª–µ—Å—Ç—ñ–∫ ‚Äî –Ω–∞—Ä—ã“õ—Ç–∞ –∫—ñ–º–¥–µ—Ä —Å–∞—Ç–∞–¥—ã –∂”ô–Ω–µ –æ–ª–∞—Ä–¥—ã“£ –∫“Ø—à—ñ.
–ú–∞—Ä–∂–∞ ‚Äî –ø–∞–π–¥–∞ –∞–ª—É –º“Ø–º–∫—ñ–Ω–¥—ñ–≥—ñ.
“∞—Å—ã–Ω—ã—Å—Ç–∞—Ä ‚Äî –∫”ô—Å—ñ–ø–∫–µ—Ä–≥–µ –Ω–∞“õ—Ç—ã –∫–µ“£–µ—Å.

–°–∞–±—ã—Ä–ª—ã, —Å–µ–Ω—ñ–º–¥—ñ –∂”ô–Ω–µ –∫”ô—Å—ñ–±–∏ —Å—Ç–∏–ª—å–¥—ñ —Å–∞“õ—Ç–∞.
"""

# ------------------------------------
#  –í—ã–±–æ—Ä system prompt –ø–æ —è–∑—ã–∫—É
# ------------------------------------
def get_prompt(lang):
    if lang == "kg":
        return SYSTEM_PROMPT_KG
    if lang == "kz":
        return SYSTEM_PROMPT_KZ
    return SYSTEM_PROMPT_RU


# ------------------------------------
#  –°—Ç–∞—Ä—Ç
# ------------------------------------
@router.message(Command("start"))
async def start_cmd(message: Message):
    user_id = message.from_user.id
    set_user_language(user_id, "ru")  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä—É—Å—Å–∫–∏–π

    await message.answer(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ArtBazar AI ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –æ–Ω–ª–∞–π–Ω.\n–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        reply_markup=main_menu_keyboard(lang="choose")
    )


# ------------------------------------
#  –í—ã–±–æ—Ä —è–∑—ã–∫–∞
# ------------------------------------
@router.message(F.text.in_(["–†—É—Å—Å–∫–∏–π üá∑üá∫", "–ö—ã—Ä–≥—ã–∑—á–∞ üá∞üá¨", "“ö–∞–∑–∞“õ—à–∞ üá∞üáø"]))
async def choose_language(message: Message):
    lang_map = {
        "–†—É—Å—Å–∫–∏–π üá∑üá∫": "ru",
        "–ö—ã—Ä–≥—ã–∑—á–∞ üá∞üá¨": "kg",
        "“ö–∞–∑–∞“õ—à–∞ üá∞üáø": "kz",
    }

    lang = lang_map.get(message.text)
    set_user_language(message.from_user.id, lang)

    texts = {
        "ru": "–Ø–∑—ã–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
        "kg": "–¢–∏–ª —Å–∞–∫—Ç–∞–ª–¥—ã. –ö–∞–Ω—Ç–∏–ø –∂–∞—Ä–¥–∞–º –±–µ—Ä–µ–º?",
        "kz": "–¢—ñ–ª —Å–∞“õ—Ç–∞–ª–¥—ã. “ö–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω?"
    }

    await message.answer(texts[lang], reply_markup=main_menu_keyboard(lang))


# ------------------------------------
#  –ö–æ–º–∞–Ω–¥—ã –º–µ–Ω—é: –ê–ò –∞–Ω–∞–ª–∏–∑
# ------------------------------------
@router.message(F.text == "–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ üìä")
async def ask_market(message: Message):
    lang = get_user_language(message.from_user.id)

    prompts = {
        "ru": "–û–ø–∏—à–∏ —Ç–æ–≤–∞—Ä –∏–ª–∏ –Ω–∏—à—É, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞.",
        "kg": "–ê–Ω–∞–ª–∏–∑ –∫—ã–ª—ã—à “Ø—á“Ø–Ω —Ç–æ–≤–∞—Ä –∂–µ –Ω–∏—à–µ–Ω–∏ –∂–∞–∑—ã“£—ã–∑.",
        "kz": "–ù–∞—Ä—ã“õ—Ç—ã“õ —Ç–∞–ª–¥–∞—É “õ–∞–∂–µ—Ç —Ç–∞—É–∞—Ä–¥—ã –Ω–µ–º–µ—Å–µ –Ω–∏—à–∞–Ω—ã –∂–∞–∑—ã“£—ã–∑."
    }

    await message.answer(prompts[lang])


@router.message(F.text == "–ü–æ–¥–±–æ—Ä –Ω–∏—à–∏ üéØ")
async def ask_niche(message: Message):
    lang = get_user_language(message.from_user.id)

    prompts = {
        "ru": "–û–ø–∏—à–∏, —á–µ–º —Ö–æ—á–µ—à—å –∑–∞–Ω–∏–º–∞—Ç—å—Å—è. –ë–æ—Ç –æ—Ü–µ–Ω–∏—Ç –Ω–∏—à—É.",
        "kg": "–≠–º–Ω–µ –º–µ–Ω–µ–Ω –∞–ª–µ–∫—Ç–µ–Ω–≥–∏“£–∏–∑ –∫–µ–ª–µ—Ç? –ù–∏—à–∞ —Ç–∞–ª–¥–∞–Ω—ã–ø –±–µ—Ä–∏–ª–µ—Ç.",
        "kz": "“ö–∞–Ω–¥–∞–π –±–∞“ì—ã—Ç–ø–µ–Ω –∞–π–Ω–∞–ª—ã—Å“õ—ã“£ –∫–µ–ª–µ–¥—ñ? –ù–∏—à–∞ —Ç–∞–ª–¥–∞–Ω—ã–ø –±–µ—Ä—ñ–ª–µ–¥—ñ."
    }

    await message.answer(prompts[lang])


@router.message(F.text == "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ä–∂–∏ üí∞")
async def profit_stub(message: Message):
    lang = get_user_language(message.from_user.id)
    
    texts = {
        "ru": "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ä–∂–∏ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.",
        "kg": "–ú–∞—Ä–∂–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É –∂–∞–∫—ã–Ω–¥–∞ –∫–æ—à—É–ª–∞—Ç.",
        "kz": "–ú–∞—Ä–∂–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã –∂–∞“õ—ã–Ω–¥–∞ “õ–æ—Å—ã–ª–∞–¥—ã."
    }

    await message.answer(texts[lang])


@router.message(F.text == "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚ö°")
async def ask_recommend(message: Message):
    lang = get_user_language(message.from_user.id)

    prompts = {
        "ru": "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Ç–æ–≤–∞—Ä–µ –∏ —Å–∏—Ç—É–∞—Ü–∏–∏, –¥–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.",
        "kg": "–¢–æ–≤–∞—Ä —Ç—É—É—Ä–∞–ª—É—É –∂–∞–∑—ã“£—ã–∑, —Å—É–Ω—É—à—Ç–∞—Ä–¥—ã –±–µ—Ä–µ–º.",
        "kz": "–¢–∞—É–∞—Ä –º–µ–Ω –∂–∞“ì–¥–∞–π–¥—ã —Å–∏–ø–∞—Ç—Ç–∞, –∫–µ“£–µ—Å –±–µ—Ä–µ–º—ñ–Ω."
    }

    await message.answer(prompts[lang])


# ------------------------------------
#  –û–ë–†–ê–ë–û–¢–ö–ê –í–°–ï–ì–û –û–°–¢–ê–õ–¨–ù–û–ì–û ‚Äî OPENAI
# ------------------------------------
@router.message()
async def ai_answer(message: Message):
    user_id = message.from_user.id
    lang = get_user_language(user_id) or "ru"

    prompt = get_prompt(lang)

    try:
        await message.answer(
            {
                "ru": "–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º‚Ä¶",
                "kg": "–ñ–æ–æ–ø –¥–∞—è—Ä–¥–∞–ª—ã–ø –∂–∞—Ç–∞—Ç‚Ä¶",
                "kz": "–ñ–∞—É–∞–ø –¥–∞–π—ã–Ω–¥–∞–ª—ã–ø –∂–∞—Ç—ã—Ä‚Ä¶"
            }[lang]
        )

        completion = client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[
                {"role": "system", "content": prompt},
                {"role": "user", "content": message.text}
            ]
        )

        await message.answer(completion.choices[0].message["content"])

    except Exception as e:
        logging.error(e)
        await message.answer(
            {
                "ru": "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.",
                "kg": "–ö–∞—Ç–∞ –∫–µ—Ç—Ç–∏.",
                "kz": "“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã."
            }[lang]
        )
